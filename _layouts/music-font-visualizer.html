---
layout: base
image: /images/music.png
seo: { "type": "MusicGroup" }
dark: true
stylesheet: /music-font-visualizer-inputrange.css
---

<header></header>
<main>
  <svg version="1.1" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 80 15" style="margin-left:-5%">
    <style>
      text {
        line-height: 1;
        font-size: 11px;
        font-weight: 100;
        font-family: {{ site.font_family }};
      }
    </style>
    <title>{{ page.title }}</title>
    <rect x="0" y="0" width="100%" height="100%" fill="black" stroke="0"></rect>
    {% assign chars = page.title | characters %}
    <text x="0" y="12" fill="white" stroke="white" stroke-width="0"><tspan>&nbsp;</tspan>{% for x in chars %}<tspan {% if forloop.first %}x="5%"{% endif %}>{{ x }}</tspan>{% endfor %}</text>
  </svg>
  <div class="controls">
    <button aria-label="Play/pause">
      <span class="line" aria-hidden="true"></span>
      <span class="line" aria-hidden="true"></span>
      <span class="line" aria-hidden="true"></span>
      <span class="line" aria-hidden="true"></span>
    </button>
    <div class="range"><input type="range" value="0" max="1" step="any"></div>
  </div>
    <audio preload>
      <source src="/music/Kofi Gumbs-{{ page.title }}.mp3" type="audio/mpeg">
    </audio>
</main>

{% include footer.html %}

<script>
  const AudioContext = window.AudioContext || window.webkitAudioContext;
  const audioContext = new AudioContext();

  const playback = document.querySelector(".controls button");
  const progress = document.querySelector(".controls input");
  const svg = document.querySelector("text");
  const audio = document.querySelector("audio");
  const source = audioContext.createMediaElementSource(audio);
  const analyser = audioContext.createAnalyser();

  source.connect(analyser);
  source.connect(audioContext.destination);
  audio.addEventListener("play", () => audioContext.resume());
  audio.addEventListener("playing", () => playback.classList.add("playing"));
  audio.addEventListener("pause", () => playback.classList.remove("playing"));
  audio.addEventListener("error",  () => playback.classList.remove("playing"));
  audio.addEventListener("ended",  () => playback.classList.remove("playing"));
  playback.addEventListener("click", () => audio.paused ? audio.play() : audio.pause());
  progress.addEventListener("input", () => audio.currentTime = progress.value * audio.duration);

  analyser.fftSize = 256;
  const letters = Array.from(svg.children).slice(1);
  const buffer = new Uint8Array(analyser.frequencyBinCount);
  const step = analyser.frequencyBinCount / letters.length / 2;
  (function loop() {
    requestAnimationFrame(loop);

    if (audio.readyState <= 0) return;

    analyser.getByteFrequencyData(buffer);
    for(let i = 0; i < letters.length; i++) {
      const data = buffer.slice(Math.floor(i * step), Math.ceil((i + 1) * step));
      let sum = 0;
      data.forEach(x => sum += x);
      letters[i].style.strokeWidth = sum / data.length / 96;
    }

    progress.value = audio.currentTime / audio.duration;
  })();
</script>
